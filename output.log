============================= test session starts =============================
platform win32 -- Python 3.11.0, pytest-9.0.2, pluggy-1.6.0
rootdir: D:\iriskassist360_backend
plugins: anyio-4.12.0
collected 6 items

tests\test_api.py .....F                                                 [100%]

================================== FAILURES ===================================
_________________________ test_quote_calculation_sfsp _________________________

    def test_quote_calculation_sfsp():
        """f) test_quote_calculation_sfsp: POST /api/quote/calculate"""
        # Try generic endpoint first
        url = "/api/quote/calculate"
    
        # Payload assuming generic structure or tailored for SFSP
        payload = {
            "product_code": "SFSP",
            "building_si": 1000000,
            "occupancy": "Warehouse",
            "pa_selected": False,
            "add_ons": [
                 {"code": "CMST"}
            ]
        }
    
        try:
            resp = client.post(url, json=payload)
    
            if resp.status_code == 404:
                # Fallback to specific endpoint
                url = "/irisk/fire/uiic/sfsp/calculate"
                # Adjust payload (uiic_fire.py structure)
                payload = {
                    "building_si": 1000000,
                    "occupancy": "Warehouse",
                    "pa_selected": False
                }
                resp = client.post(url, json=payload)
    
>           assert resp.status_code == 200, f"Quote calc failed: {resp.status_code} - {resp.text}"
E           AssertionError: Quote calc failed: 500 - {"success":false,"message":"Internal Server Error","data":"type object 'Rate' has no attribute 'occupancy'"}
E           assert 500 == 200
E            +  where 500 = <Response [500 Internal Server Error]>.status_code

tests\test_api.py:153: AssertionError

During handling of the above exception, another exception occurred:

    def test_quote_calculation_sfsp():
        """f) test_quote_calculation_sfsp: POST /api/quote/calculate"""
        # Try generic endpoint first
        url = "/api/quote/calculate"
    
        # Payload assuming generic structure or tailored for SFSP
        payload = {
            "product_code": "SFSP",
            "building_si": 1000000,
            "occupancy": "Warehouse",
            "pa_selected": False,
            "add_ons": [
                 {"code": "CMST"}
            ]
        }
    
        try:
            resp = client.post(url, json=payload)
    
            if resp.status_code == 404:
                # Fallback to specific endpoint
                url = "/irisk/fire/uiic/sfsp/calculate"
                # Adjust payload (uiic_fire.py structure)
                payload = {
                    "building_si": 1000000,
                    "occupancy": "Warehouse",
                    "pa_selected": False
                }
                resp = client.post(url, json=payload)
    
            assert resp.status_code == 200, f"Quote calc failed: {resp.status_code} - {resp.text}"
            data = resp.json()
    
            d = data.get("data", {})
    
            # Check basic premium if available
            if "basic_premium" in d:
                assert d["basic_premium"] == 400.0, f"Basic Premium mismatch: {d['basic_premium']}"
    
        except Exception as e:
>           pytest.fail(f"Quote calculation check failed: {e}")
E           Failed: Quote calculation check failed: Quote calc failed: 500 - {"success":false,"message":"Internal Server Error","data":"type object 'Rate' has no attribute 'occupancy'"}
E           assert 500 == 200
E            +  where 500 = <Response [500 Internal Server Error]>.status_code

tests\test_api.py:163: Failed
------------------------------ Captured log call ------------------------------
ERROR    irisk_backend:main.py:55 Request Failed: type object 'Rate' has no attribute 'occupancy'
============================== warnings summary ===============================
app\schemas\user_schema.py:11
  D:\iriskassist360_backend\app\schemas\user_schema.py:11: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class UserOut(BaseModel):

.venv\Lib\site-packages\pydantic\_internal\_config.py:383
  D:\iriskassist360_backend\.venv\Lib\site-packages\pydantic\_internal\_config.py:383: UserWarning: Valid config keys have changed in V2:
  * 'orm_mode' has been renamed to 'from_attributes'
    warnings.warn(message, UserWarning)

app\schemas\response.py:3
  D:\iriskassist360_backend\app\schemas\response.py:3: PydanticDeprecatedSince20: `pydantic.generics:GenericModel` has been moved to `pydantic.BaseModel`. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    from pydantic.generics import GenericModel

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ===========================
FAILED tests/test_api.py::test_quote_calculation_sfsp - Failed: Quote calcula...
=================== 1 failed, 5 passed, 3 warnings in 1.44s ===================
